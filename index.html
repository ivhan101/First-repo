<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Full-Stack App (Student Build)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .page { display: none; }
    .page.active { display: block; }
    body.not-authenticated .role-logged-in { display: none; }
    body.authenticated .role-logged-out { display: none; }
    .role-admin { display: none; }
    body.is-admin .role-admin { display: block; }
  </style>
</head>
<body class="not-authenticated">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#/">Full-Stack App</a>
    <ul class="navbar-nav ms-auto">
      <li class="nav-item role-logged-out"><a class="nav-link" href="#/login">Login</a></li>
      <li class="nav-item role-logged-out"><a class="nav-link" href="#/register">Register</a></li>

      <li class="nav-item dropdown role-logged-in">
        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
          <span id="nav-username"></span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#/profile">Profile</a></li>
          <li><a class="dropdown-item" href="#/requests">My Requests</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#" id="logoutBtn">Logout</a></li>
        </ul>
      </li>

      <li class="nav-item role-admin"><a class="nav-link" href="#/employees">Employees</a></li>
      <li class="nav-item role-admin"><a class="nav-link" href="#/departments">Departments</a></li>
      <li class="nav-item role-admin"><a class="nav-link" href="#/accounts">Accounts</a></li>
    </ul>
  </div>
</nav>

<main class="container py-4">
  <section id="home-page" class="page active"><h3>Welcome to the Full-Stack Demo App</h3></section>

  <section id="register-page" class="page">
    <h3>Register</h3>
    <form id="registerForm">
      <input class="form-control mb-2" placeholder="First Name" required id="regFn">
      <input class="form-control mb-2" placeholder="Last Name" required id="regLn">
      <input class="form-control mb-2" placeholder="Email" type="email" required id="regEmail">
      <input class="form-control mb-2" placeholder="Password" type="password" minlength="6" required id="regPw">
      <button class="btn btn-primary">Register</button>
    </form>
  </section>

  <section id="verify-email-page" class="page">
    <h3>Email Verification</h3>
    <p id="verifyMsg"></p>
    <button class="btn btn-success" id="verifyBtn">Simulate Email Verification</button>
  </section>

  <section id="login-page" class="page">
    <h3>Login</h3>
    <form id="loginForm">
      <input class="form-control mb-2" placeholder="Email" required id="loginEmail">
      <input class="form-control mb-2" placeholder="Password" type="password" required id="loginPw">
      <button class="btn btn-success">Login</button>
    </form>
    <div class="text-danger mt-2" id="loginError"></div>
  </section>

  <section id="profile-page" class="page"><h3>Profile</h3><div id="profileBox"></div></section>

  <section id="accounts-page" class="page role-admin"><h3>Accounts</h3><div id="accountsTable"></div></section>
  <section id="departments-page" class="page role-admin"><h3>Departments</h3><div id="deptTable"></div></section>
  <section id="employees-page" class="page role-admin"><h3>Employees</h3><div id="empTable"></div></section>

  <section id="requests-page" class="page"><h3>My Requests</h3><div id="reqTable"></div></section>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const STORAGE_KEY = 'ipt_demo_v1';
let currentUser = null;
window.db = { accounts: [], departments: [], employees: [], requests: [] };

function saveToStorage(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
function loadFromStorage(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){ try{ Object.assign(db, JSON.parse(raw)); return; }catch{} }
  db.accounts.push({first:'Admin',last:'User',email:'admin@example.com',password:'Password123!',role:'admin',verified:true});
  db.departments.push({id:1,name:'Engineering'},{id:2,name:'HR'});
  saveToStorage();
}

function setAuthState(isAuth,user){
  document.body.classList.toggle('authenticated',isAuth);
  document.body.classList.toggle('not-authenticated',!isAuth);
  document.body.classList.toggle('is-admin', user && user.role==='admin');
  currentUser=user||null;
  document.getElementById('nav-username').textContent = user? user.first:'';
}

function navigateTo(h){ location.hash=h; }

function handleRouting(){
  const hash = location.hash || '#/';
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const map = {
    '#/':'home-page', '#/register':'register-page', '#/login':'login-page', '#/verify-email':'verify-email-page',
    '#/profile':'profile-page', '#/accounts':'accounts-page', '#/departments':'departments-page', '#/employees':'employees-page', '#/requests':'requests-page'
  };
  const pageId = map[hash] || 'home-page';
  if(['#/profile','#/requests'].includes(hash) && !currentUser) return navigateTo('#/login');
  if(['#/accounts','#/departments','#/employees'].includes(hash) && (!currentUser || currentUser.role!=='admin')) return navigateTo('#/');
  document.getElementById(pageId).classList.add('active');
  if(hash==='#/profile') renderProfile();
  if(hash==='#/accounts') renderAccounts();
}

registerForm.onsubmit=e=>{
  e.preventDefault();
  if(db.accounts.find(a=>a.email===regEmail.value)) return alert('Email exists');
  db.accounts.push({first:regFn.value,last:regLn.value,email:regEmail.value,password:regPw.value,role:'user',verified:false});
  localStorage.unverified_email=regEmail.value; saveToStorage(); navigateTo('#/verify-email');
};

verifyBtn.onclick=()=>{
  const u=db.accounts.find(a=>a.email===localStorage.unverified_email); if(u){u.verified=true; saveToStorage();}
  navigateTo('#/login');
};

loginForm.onsubmit=e=>{
  e.preventDefault();
  const u=db.accounts.find(a=>a.email===loginEmail.value && a.password===loginPw.value && a.verified);
  if(!u) return loginError.textContent='Invalid credentials';
  localStorage.auth_token=u.email; setAuthState(true,u); navigateTo('#/profile');
};

logoutBtn.onclick=()=>{ localStorage.removeItem('auth_token'); setAuthState(false); navigateTo('#/'); };

function renderProfile(){ profileBox.innerHTML=`<p><b>Name:</b> ${currentUser.first} ${currentUser.last}</p><p><b>Email:</b> ${currentUser.email}</p><p><b>Role:</b> ${currentUser.role}</p>`; }
function renderAccounts(){ accountsTable.innerHTML='<ul>'+db.accounts.map(a=>`<li>${a.email} (${a.role})</li>`).join('')+'</ul>'; }

window.addEventListener('hashchange',handleRouting);
loadFromStorage();
const token=localStorage.auth_token; if(token){ const u=db.accounts.find(a=>a.email===token); if(u) setAuthState(true,u); }
handleRouting();
</script>
</body>
</html>
